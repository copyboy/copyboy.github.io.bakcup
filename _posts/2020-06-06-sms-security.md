---
layout: post
title: 信息安全 - 短信验证码
categories: 信息安全
description: 短信验证码恶意调用及问题修复
keywords: sms, 短信, 验证码
---

## 短信验证码恶意调用及问题修复

### 业务场景问题

- 短信平台使用[云片](https://www.yunpian.com/)

- 由平台针对单一手机号做了频率的限制

- 页面前端做了短信频率控制

  

### 引发的问题

- 第三方恶意调用（猜测使用批量脚本工具请求，针对单独的发送验证码接口进行请求）

  

### 问题解决方案：

- 前端后台统一做短信发送频率控制
- 请求头refer限定，只能是从注册短信页面发送过来的请求
- 页面添加隐藏域授权token，必送且有时效，避免单独调起短信发送接口
- 号码段控制，同一个号码段（前7/8位），当天最多发送X条，
- IP 控制，一个 IP 当天最多请求X次注册接口（需要衡量，因为多数都是公网IP，同一个地域如果出现业务爆发增长，会出现误伤问题，所以最好做成配置项）



### 集成解决方案 Daming

由[ThoughtWorks](https://insights.thoughtworks.cn/)公司同学提供



[不就是个短信登录API嘛，有这么复杂吗？](https://insights.thoughtworks.cn/sms-authentication-login-api/)

[TW Daming Github](https://github.com/TheBund1st/daming/wiki/%E4%B8%8D%E5%B0%B1%E6%98%AF%E4%B8%AA%E7%9F%AD%E4%BF%A1%E9%AA%8C%E8%AF%81%E5%98%9B%EF%BC%8C%E6%9C%89%E8%BF%99%E4%B9%88%E5%A4%8D%E6%9D%82%E5%90%97%EF%BC%9F)



- 短信验证码有效期2分钟
- 验证码为6位纯数字
- 每个手机号60秒内只能发送一次短信验证码，且这一规则的校验必须在服务器端执行
- 同一个手机号在同一时间内可以有多个有效的短信验证码
- 保存于服务器端的验证码，至多可被使用3次（无论和请求中的验证码是否匹配），随后立即作废，以防止暴力攻击
- 短信验证码不可直接记录到日志文件
- 发送短信验证码之前，先验证图形验证码是否正确（可选）
- 集成第三方API做登录保护（可选）
- 应该可以通过配置白名单的方式，只向特定手机号码发送验证码，以免在非生产环境测试时发生打扰真实用户的事故
- 应该可以通过配置By Pass的方式，在特定环境禁用短信验证码发送，并总是验证通过，以便在非生产环境节约短信配额 一个小小的需求可以衍生出如此之多的验收条件，而且其中不少是非功能性的（不容易识别的、不容易实现的），以至于有同学感叹：




